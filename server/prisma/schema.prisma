generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/////////////////////////////////////////////////////////////
// üöπ USER MODEL (Auth, profile)
/////////////////////////////////////////////////////////////

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())

  bankAccounts   BankAccount[]
  transactions   Transaction[]
  notifications  Notification[]
  cards          Card[]
  chequeRequests ChequeRequest[]
  refreshTokens  RefreshToken[]
  auditLogs      AuditLog[]
}

enum Role {
  USER
  ADMIN
}

/////////////////////////////////////////////////////////////
// üè¶ BANK ACCOUNT MODEL
/////////////////////////////////////////////////////////////

model BankAccount {
  id        Int         @id @default(autoincrement())
  bankName  String
  shortName String?
  accountNo String      @unique
  type      AccountType @default(SAVINGS)
  balance   Decimal     @default("0.00") @db.Decimal(12, 2)
  logo      String?
  color     String?
  bgColor   String?
  createdAt DateTime    @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  transactions  Transaction[]
  transfersFrom Transfer[]    @relation("TransferFrom")
  transfersTo   Transfer[]    @relation("TransferTo")

  @@index([userId])
}

enum AccountType {
  SAVINGS
  CURRENT
}

/////////////////////////////////////////////////////////////
// üí∏ TRANSACTIONS MODEL
/////////////////////////////////////////////////////////////

model Transaction {
  id          Int      @id @default(autoincrement())
  amount      Decimal  @db.Decimal(12, 2)
  type        TxType
  category    Category @default(OTHER)
  description String?
  timestamp   DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  accountId Int
  account   BankAccount @relation(fields: [accountId], references: [id])

  @@index([userId])
  @@index([accountId])
  @@index([timestamp])
}

enum TxType {
  CREDIT
  DEBIT
}

enum Category {
  FOOD
  SHOPPING
  TRANSPORT
  BILLS
  ENTERTAINMENT
  TRANSFER
  INCOME
  REFUND
  OTHER
}

/////////////////////////////////////////////////////////////
// üîî NOTIFICATIONS
/////////////////////////////////////////////////////////////

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@index([userId])
}

/////////////////////////////////////////////////////////////
// üí≥ CARD SERVICES
/////////////////////////////////////////////////////////////

model Card {
  id        Int        @id @default(autoincrement())
  status    CardStatus @default(ACTIVE)
  number    String     @unique
  createdAt DateTime   @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])
}

enum CardStatus {
  ACTIVE
  BLOCKED
}

/////////////////////////////////////////////////////////////
// üßæ CHEQUE BOOK REQUEST MODEL
/////////////////////////////////////////////////////////////

model ChequeRequest {
  id        Int          @id @default(autoincrement())
  status    ChequeStatus @default(PENDING)
  createdAt DateTime     @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])
}

enum ChequeStatus {
  PENDING
  APPROVED
  REJECTED
}

/////////////////////////////////////////////////////////////
// üîÅ TRANSFER LOGS (simulated internal transfers)
/////////////////////////////////////////////////////////////

model Transfer {
  id             Int      @id @default(autoincrement())
  amount         Decimal  @db.Decimal(12, 2)
  createdAt      DateTime @default(now())
  fromAccountId  Int
  toAccountId    Int
  note           String?
  idempotencyKey String?  @unique

  fromAccount BankAccount @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount   BankAccount @relation("TransferTo", fields: [toAccountId], references: [id])
}

/////////////////////////////////////////////////////////////
// üîÅ REFRESH TOKENS (httpOnly cookie flow)
/////////////////////////////////////////////////////////////

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])
}

/////////////////////////////////////////////////////////////
// ü™™ AUDIT LOGS
/////////////////////////////////////////////////////////////

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  meta      String? // store JSON string if needed
  ip        String?
  ua        String? // user agent
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])
}
